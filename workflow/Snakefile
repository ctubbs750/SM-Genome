from snakemake.utils import min_version

min_version("7.32.4")


configfile: "config/config.yaml"


# Parameters
BUILDS = config["GENOME"]["BUILDS"]
PROVIDER = config["GENOME"]["PROVIDER"]
FILTER = config["GENOME"]["FILTER"]
OUTDIR = config["GENOME"]["OUTDIR"]

rule all:
    input:
        expand("resources/data/genome/{ASSEMBLY}/{ASSEMBLY}.fa.gz", ASSEMBLY=BUILDS),
        expand("resources/data/genome/{ASSEMBLY}/{ASSEMBLY}.blacklist.bed", ASSEMBLY=BUILDS),
        expand("resources/data/genome/{ASSEMBLY}/{ASSEMBLY}.gaps.bed", ASSEMBLY=BUILDS),

rule install_genome:
    default_target: True
    message:
        """
        Installs target genome(s) under install dir
        - Regex to filter down to main chromosomes
        - Default provider set to UCSC
        """
    output:
        "resources/data/genome/{ASSEMBLY}/{ASSEMBLY}.fa.gz",
        "resources/data/genome/{ASSEMBLY}/{ASSEMBLY}.blacklist.bed",
        "resources/data/genome/{ASSEMBLY}/{ASSEMBLY}.gaps.bed",
    params:
        provider=PROVIDER,
        regex=FILTER,
        outdir=OUTDIR,
    conda:
        "envs/genome.yaml"
    threads: 16
    log:
        stdout="workflow/logs/install_genome-{ASSEMBLY}.stdout",
        stderr="workflow/logs/install_genome-{ASSEMBLY}.stderr",
    shell:
        """
        genomepy plugin enable blacklist &&
        genomepy install {params.assembly} \
        --provider {params.provider} \
        --genomes_dir {params.outdir} \
        --bgzip \
        --threads {threads} \
        --regex {params.regex}
        """
